# â”€â”€ DINOv2-small ONNX Lambda â€” Build & Push â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#
# Targets:
#   download-model  â€” Fetch DINOv2 ViT-S/14 ONNX from HuggingFace
#   build           â€” Build Docker container image
#   login           â€” Authenticate Docker to ECR
#   push            â€” Tag + push image to ECR
#   deploy          â€” download-model â†’ build â†’ login â†’ push (all-in-one)
#   clean           â€” Remove downloaded model + Docker image
#
# Prerequisites:
#   - Docker
#   - AWS CLI (authenticated)
#   - wget or curl
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

AWS_ACCOUNT  ?= 659271373941
AWS_REGION   ?= ca-central-1
ECR_REPO     ?= pledgeproof-dinov2
IMAGE_TAG    ?= latest

ECR_URI      = $(AWS_ACCOUNT).dkr.ecr.$(AWS_REGION).amazonaws.com/$(ECR_REPO)
MODEL_DIR    = src/model
MODEL_FILE   = $(MODEL_DIR)/dinov2_vits14.onnx
MODEL_URL    = https://huggingface.co/sefaburak/dinov2-small-onnx/resolve/main/dinov2_vits14.onnx

.PHONY: download-model build login push deploy clean

# â”€â”€ Download ONNX model from HuggingFace â”€â”€
download-model: $(MODEL_FILE)

$(MODEL_FILE):
	@mkdir -p $(MODEL_DIR)
	@echo "â¬‡  Downloading DINOv2-small ONNX model..."
	@wget -q --show-progress -O $(MODEL_FILE) "$(MODEL_URL)" || \
		curl -L -o $(MODEL_FILE) "$(MODEL_URL)"
	@echo "âœ“  Model saved to $(MODEL_FILE)"

# â”€â”€ Build Docker image â”€â”€
build: $(MODEL_FILE)
	@echo "ðŸ³ Building Docker image $(ECR_REPO):$(IMAGE_TAG) (linux/amd64)..."
	@docker buildx build --platform linux/amd64 -t $(ECR_REPO):$(IMAGE_TAG) src/
	@echo "âœ“  Image built"

# â”€â”€ Login to ECR â”€â”€
login:
	@echo "ðŸ”‘ Logging into ECR..."
	@aws ecr get-login-password --region $(AWS_REGION) | \
		docker login --username AWS --password-stdin $(AWS_ACCOUNT).dkr.ecr.$(AWS_REGION).amazonaws.com
	@echo "âœ“  Logged in"

# â”€â”€ Push to ECR â”€â”€
push: login
	@echo "ðŸ“¤ Pushing to $(ECR_URI):$(IMAGE_TAG)..."
	@docker tag $(ECR_REPO):$(IMAGE_TAG) $(ECR_URI):$(IMAGE_TAG)
	@docker push $(ECR_URI):$(IMAGE_TAG)
	@echo "âœ“  Pushed"

# â”€â”€ All-in-one â”€â”€
deploy: download-model build push
	@echo "ðŸš€ Done â€” image available at $(ECR_URI):$(IMAGE_TAG)"

# â”€â”€ Cleanup â”€â”€
clean:
	@rm -rf $(MODEL_DIR)
	@docker rmi $(ECR_REPO):$(IMAGE_TAG) $(ECR_URI):$(IMAGE_TAG) 2>/dev/null || true
	@echo "âœ“  Cleaned"
